<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Presentation</title>

  <meta name="viewport" content="width=device-width"/>

  <link rel="stylesheet" href="./css/reset.css" type="text/css"/>
  <link rel="stylesheet" href="./css/showoff.css" type="text/css"/>

  <link type="text/css" href="./css/fg.menu.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/theme/ui.all.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/sh_style.css" rel="stylesheet" />

  <script type="text/javascript" src="./js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="./js/jquery.cycle.all.js"></script>
	<script type="text/javascript" src="./js/jquery-print.js"></script>
  <script type="text/javascript" src="./js/jquery.batchImageLoad.js"></script>

  <script type="text/javascript" src="./js/jquery.doubletap-0.1.js"></script>

  <script type="text/javascript" src="./js/fg.menu.js"></script>
  <script type="text/javascript" src="./js/showoff.js"></script>
  <script type="text/javascript" src="./js/jTypeWriter.js"> </script>
  <script type="text/javascript" src="./js/sh_main.min.js"></script>
  <script type="text/javascript" src="./js/core.js"></script>
  <script type="text/javascript" src="./js/showoffcore.js"></script>
  <script type="text/javascript" src="./js/coffee-script.js"></script>

  
    
      <script type="text/javascript" src="./js/sh_lang/sh_ruby.min.js"></script>
    
  

  
    <link rel="stylesheet" href="./file/000_sh_vim-dark.css" type="text/css"/>
  
    <link rel="stylesheet" href="./file/styles.css" type="text/css"/>
  

  

  <script type="text/javascript">
  $(function(){
      setupPreso(false, './');
  });
  </script>

</head>

<body>

<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>

<div id="help">
  <table>
    <tr><td class="key">z, ?</td><td>toggle help (this)</td></tr>
    <tr><td class="key">space, &rarr;</td><td>next slide</td></tr>
    <tr><td class="key">shift-space, &larr;</td><td>previous slide</td></tr>
    <tr><td class="key">d</td><td>toggle debug mode</td></tr>
    <tr><td class="key">## &lt;ret&gt;</td><td>go to slide #</td></tr>
    <tr><td class="key">c, t</td><td>table of contents (vi)</td></tr>
    <tr><td class="key">f</td><td>toggle footer</td></tr>
    <tr><td class="key">r</td><td>reload slides</td></tr>
    <tr><td class="key">n</td><td>toggle notes</td></tr>
    <tr><td class="key">p</td><td>run preshow</td></tr>
    <tr><td class="key">P</td><td>toggle pause</td></tr>
  </table>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso">loading presentation...</div>
<div id="footer">
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
</div>

<div id="slides" class="offscreen" style="display:none;">
<html><body><div style="background: url('file/./pictures/jacob.jpg') center no-repeat;" class="slide" data-transition="none">
<div class="content black" ref="./slides/1">
<h3>Jacob Burkhart</h3>

<p><br><br><br><br><br><br><br><br><br><br><br><br><br></p>

<h2>@beanstalksurf</h2>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/engineyard.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/2">
<h1>&#160;&#160;&#160; Engine Yard</h1>

<p class="notes">we run servers on amazon, we coordinate things for you.  We bill our customers (billing system), we support our customers (zendesk integration), we have sales and marketing (salesforce integration).</p>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/wall.jpg') center no-repeat;" class="slide" data-transition="none">
<div class="content shadowh2" ref="./slides/3">
<h3>Living with Distributed Systems</h3>

<p><br><br><br><br><br><br><br></p>

<h2><code>jacobo.github.com/distributed_systems</code></h2>

<p class="notes">I want to talk to you about what it's like to work at engine yard, and more specifically what it's like to work on borders.  By borders I mean the interactions between systems. And in a way this is inevitable. Even if we tried to consolidate our entire platform into a single monolithic ruby on rails application, we still have to communicate with every one of our customers servers running on ec2, and with our command line tools.  So despite beginning as a monolithic app, our engineers have had to deal with a distributed product form the beginning.  And coming in several years after that, I get the benefit of their mistakes. But, I still have room to make mistakes of my own and learn from them. In researching this topic I see lots of talks out there that spend a lot of type justifying SOA, or explaining why you want multiple systems. I am going to gloss over all of that and try to get to what I consider to be the meat of the problem. Which is the part I think is the hard part. The part where you're likely to make mistakes. And maybe I'm wrong, maybe deciding to do SOA in the first place is the hard part.  But nonetheless, let's proceed.</p>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/ey-soa.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/4">
<h1>&#160;</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content bullets" ref="./slides/5">
<ul>
<li>The Basics</li>
<li>Coupling</li>
<li>Shipping</li>
<li>Resiliency</li>
<li>Maintenance</li>
</ul>
<p class="notes">It can be messy. I'm going to tell you a bunch of assumptions we make at EY about services. These might not be applicable to everyone or even the right set of assumptions for you. But these assumptions frame all of the services we write and will make it easier for me to talk about them. And having these assumptions commons to all services makes it easier for our development team to move between our main app and dependent services whose codebase they may have never looked at before.  So the assumptions are all very basic, but it's important that we have them.</p>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/6">
<h4>The Basics</h4>

<h1>Every piece of knowledge must have a single, unambiguous, authoritative representation within a system</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/7">
<p><br></p>

<h3>Server Providing a Service</h3>

<p><br><br></p>

<h3>Client Consuming a Service</h3>

<p class="notes">There's something providing a service (server or provider). There's something consuming a service (client or consumer). This are often many clients consuming a single service. A One-to-Many relationship.</p>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/01-simple.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/8">
<h4>Client and Server</h4>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/02-with-apps.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/9">
<h4>Two Apps</h4>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content bullets incremental" ref="./slides/10">
<h3>The ONLY way to communicate is HTTPS</h3>

<ul>
<li>No Shared Database</li>
<li>No Shared Redis / Memcached</li>
<li>No Message Bus</li>
</ul>
<p class="notes">no shared database, no shared disk, no message bus. Nothing against message buses, but that would be an entirely different talk. And while we've talked about it many times at EY. We've never deployed a service that provides is service to other applications via a message bus.</p>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/one-env.png') center no-repeat;" class="slide" data-transition="none">
<div class="content leftbanner" ref="./slides/11">
<h3>Easy Ops</h3>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/12">
<h3>Consumers</h3>

<pre class="sh_ruby"><code>class Consumer &lt; ActiveRecord::Base

  validates_presence_of :name

  after_initialize do
    self.auth_id ||= SecureRandom.hex(8)
    self.auth_key ||= SecureRandom.hex(40)
  end</code></pre>

<p><br></p>

<pre class="sh_ruby"><code>use EY::ApiHMAC::ApiAuth::Server, Consumer</code></pre>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/04-two-way-client.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/13">
<h4>Bi-Directional API</h4>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/05-multi-client.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/14">
<h4>Multi-Client API</h4>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/messy.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/15">
<p><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></p>

<h3>Coupling</h3>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content bullets incremental begredslash" ref="./slides/16">
<h3>The Obvious</h3>

<p><br></p>

<pre class="sh_ruby"><code>class ElephantsController &lt; ApplicationController
  def show
    Elephant.find(params[:id]).to_json
  end
end</code></pre>

<p><br></p>

<pre class="sh_ruby"><code>uri = URI.parse("http://foo.engineyard.com/elephants/1")
JSON.parse(Net::HTTP.get_response(uri))</code></pre>

<ul>
<li>Too Much Coupling!</li>
</ul>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/shai.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/17">
<h3>Mapper Pattern</h3>

<p class="notes">because this is what your co-workers will do</p>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/18">
<h3>Talk About The Mapper Pattern</h3>

<p><iframe width="560" height="315" src="http://www.youtube.com/embed/-IwihDjVvx4" frameborder="0" allowfullscreen></iframe></p>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/06-simple-mapper.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/19">
<h4>Mapper Pattern</h4>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/07-full-mapper.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/20">
<h4>Fake Mapper</h4>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/08-web-req.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/21">
<h4>Web Request</h4>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/10-app-tests.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/22">
<h4>Client App Tests</h4>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/09-api-tests.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/23">
<h4>API Tests</h4>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/11-service-tests.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/24">
<h4>Server App Tests</h4>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/12-api.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/25">
<h4>API</h4>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/26">
<h3>App Usage</h3>

<pre class="sh_ruby"><code>JohnnyCashApi::Client.send_usage(
  :uom            =&gt; "Add-on #{invoice.service.name}",
  :quantity       =&gt; invoice.total_amount_cents / 100.0,
  :description    =&gt; invoice.line_item_description,
  :date           =&gt; invoice.created_at,
  :account_sso_id =&gt; invoice.service_account.sso_account_id)</code></pre>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/27">
<h3>API Client</h3>

<pre class="sh_ruby"><code>def self.send_usage(params)
  connection.send_usage(api_url, params)
end</code></pre>

<p><br></p>

<pre class="sh_ruby"><code>class Connection &lt; EY::ApiHMAC::AuthedConnection
  def send_usage(api_url, params)
    post("#{api_url}usage", :usage =&gt; params)
  end</code></pre>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/28">
<h3>Where's the route?</h3>

<p><br></p>

<pre class="sh_ruby"><code>JohnnyCash::Application.routes.draw do

  mount JohnnyCashApi::Server.server, :at =&gt; "/api"</code></pre>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/29">
<h3>Sinatra implements the Server</h3>

<pre class="sh_ruby"><code>class ApiServer &lt; Sinatra::Base

  use EY::ApiHMAC::ApiAuth::Server, UsageSourceDelegate

  post "/usage" do
    usage_source = UsageSourceDelegate.find(request.env[EY::ApiHMAC::ApiAuth::CONSUMER])
    content_type :json
    json = JSON.parse(request.body.read)["usage"]
    mapper.handle_usage(usage_source,
      json['account_sso_id'], json['uom'], json['quantity'],
      json['description'], Time.parse(json['date']), json["remote_id"])
    {}.to_json
  end</code></pre>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/30">
<h3>Mapper implements the behavior</h3>

<pre class="sh_ruby"><code>JohnnyCashApi::Server.mapper = JohnnyCashApiMapper</code></pre>

<p><br></p>

<pre class="sh_ruby"><code>module JohnnyCashApiMapper
  def self.handle_usage(usage_source, account_sso_id, uom, quantity, description, date, remote_id)
    account = Account.find(:sso_id =&gt; account_sso_id)
    account.usages.create!(
      :remote_id     =&gt; remote_id,
      :product_type  =&gt; "addons",
      :quantity      =&gt; quantity,
      :description   =&gt; description,
      :final         =&gt; true,
      :billing_month =&gt; BillingMonth.lookup(date))
  end</code></pre>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/07-full-mapper.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/31">
<p>&#160;</p>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/joe-julian.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/32">
<h3>Sinatra in my Rails?</h3>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/33">
<h3>Mock Mode</h3>

<pre class="sh_ruby"><code>EY::ServicesAPI.enable_mock!(Rails::Application)
@mock_backend = EY::ServicesAPI.mock_backend
Capybara.app = @mock_backend.app</code></pre>
</div>
</div></body></html><html><body><div style="background: url('file/./graffles/07-full-mapper.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/34">
<h3>XML-RPC / SOAP</h3>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/joshthom.jpg') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/35">
<h3>Shipping</h3>

<p class="notes">TODO: picture of Thom and Josh?</p>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/36">
<h4>Shipping a Service</h4>

<h1>Do it Live</h1>

<h1>Do it Incrementally</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/37">
<h4>Shipping a Service</h4>

<h1>4 step migration</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/38">
<h4>Shipping a Service</h4>

<h1>1. support the old way</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/39">
<h4>Shipping a Service</h4>

<h1>2. support the new way and the old way at the same time</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/40">
<h4>Shipping a Service</h4>

<h1>3. upgrade every dependent system</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/41">
<h4>Shipping a Service</h4>

<h1>4. support only the new way</h1>

<p>(Yay! throw away all that crappy old code from the old way).</p>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/42">
<h4>Shipping a Service</h4>

<h1>There will be bugs</h1>

<h1>Be prepared to rollback</h1>

<h1>Use Feature Flags</h1>

<p class="notes">There will be bugs, so be prepared to rollback.  "support the new way and the old way at the same time" is actually 2 steps. First you do it on the server, then you do it on the client.  And use feature flags so you don't have to deploy to rollback.</p>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/slack.png') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/43">
<h3>Design for Resiliency</h3>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/44">
<h4>Design for Resiliency</h4>

<h1>Track Exceptions</h1>

<h1>Log Events</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/45">
<h4>Design for Resiliency</h4>

<h1>Retry 500s</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/46">
<h4>Design for Resiliency</h4>

<h1>Rack-Client</h1>

<h1>Rack-Idempotent</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/47">
<h4>Design for Resiliency</h4>

<h1>Timeout</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/48">
<h4>Design for Resiliency</h4>

<h1>Avoid side effects, model intent locally</h1>

<p class="notes">LaBrea problems. (much of which was solved by rack-client + rack-idempotent) weren't being sent to airbrake because of unicorn timeout. Our own timeout wasn't working because it was happening in C blocking network IO on connection to labrea. We were swallowing the exceptions because of a unicorn timeout, or because of a blanket (failure to connect to instance) error.  Having new relic would have helped us see that labrea or keymaster was having response time issues.  Needed better error handling. Never assume that it's safe to rescue exceptions from an operation you performed. Don't make service calls as after_save side effects. use a "state" or other local column to keep track of if the service call was made or not.</p>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/49">
<h4>Design for Resiliency</h4>

<h1>Cache (using Redis)</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/50">
<h4>Design for Resiliency</h4>

<h1>Ajax loading</h1>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/51">
<h4>Design for Resiliency</h4>

<h1>Read-only mode</h1>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/cemetary.jpg') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/52">
<h3>Maintenance</h3>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/53">
<h4>Maintenance</h4>

<h1>Continuous Integration</h1>

<ul>
<li>Build all Apps</li>
<li>Build all Branches</li>
<li>Build all Gems</li>
<li>Standardize Release and Deploy</li>
</ul>
<p class="notes">examples of ensemble: build, deploy, release</p>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/54">
<h4>Maintenance</h4>

<h1>The bump release repeat dance</h1>

<p class="notes">code example of Gemfile hackery?</p>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/55">
<h4>All of the tests</h4>

<ul>
<li>Test the server from the client</li>
<li>Test the client from the server</li>
<li>Use the client in your server tests</li>
</ul>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/56">
<h3>Bi-Directional Testing</h3>

<pre class="sh_ruby"><code>RSpec::Core::RakeTask.new(:internal_api_gem) do |t|
  require "ey_services_api_internal/external_test_helper"
  t.pattern = EY::ServicesAPI::Internal::
              ExternalTestHelper.rspec_pattern
  t.fail_on_error = true
end

RSpec::Core::RakeTask.new(:public_api_gem) do |t|
  require "ey_services_api/external_test_helper"
  t.pattern = EY::ServicesAPI::
              ExternalTestHelper.rspec_pattern
  t.fail_on_error = true
end

task :spec =&gt; ['spec:rails', 'spec:internal_api_gem', 
               'spec:public_api_gem']</code></pre>
</div>
</div></body></html><html><body><div class="slide" data-transition="none">
<div class="content" ref="./slides/57">
<h3>See Also</h3>

<p></p>
<center>
<iframe width="560" height="315" src="http://www.youtube.com/embed/jk88Da3jm3c" frameborder="0" allowfullscreen></iframe>
</center>
</div>
</div></body></html><html><body><div style="background: url('file/./pictures/tidepool.jpg') center no-repeat;" class="slide" data-transition="none">
<div class="content" ref="./slides/58">
<h3>Questions?</h3>
</div>
</div></body></html></div>
<div id="pauseScreen">
  
</div>

</body>
</html>
